# GPT2 Fine-tuning

## wikihow
- SageMaker HuggingFaceコンテナを使用したPyTorchでのトレーニングジョブ
  - HuggingFaceの[run_clm.py](https://github.com/huggingface/transformers/blob/master/examples/pytorch/language-modeling/run_clm.py)を使用
  - 日本語で動作するよう一部変更

- [wikiHow日本語要約データセット](https://github.com/Katsumata420/wikihow_japanese)と[rinna株式会社のjapanese-gpt2-medium](https://huggingface.co/rinna/japanese-gpt2-medium)を使用したFine-Tuning
  - 記事本文を条件に要約した内容を出力するようFine-Tuning

**SageMakerノートブックインスタンスのボリュームサイズは20GB以上必要になります（ローカル推論の際にモデルをs3からダウンロードする必要があるため）。**

#### Local環境での推論
```python
import torch
from transformers import AutoModelForCausalLM, T5Tokenizer

device = torch.device("cuda" if torch.cuda.is_available() else "cpu")
tokenizer = T5Tokenizer.from_pretrained("rinna/japanese-gpt2-medium")
model = AutoModelForCausalLM.from_pretrained('output/')
model.to(device)
model.eval()

def generate_summary(body, num_gen=5):
    input_text = '<s>'+body+'[SEP]'
    input_ids = tokenizer.encode(input_text, return_tensors='pt').to(device)
    out = model.generate(input_ids, do_sample=True, top_p=0.95, top_k=40,
                         num_return_sequences=num_gen, max_length=1024, bad_words_ids=[[1], [5]])
    print('='*5,'原文', '='*5)
    print(body)
    print('-'*5, '要約', '-'*5)
    for sent in tokenizer.batch_decode(out):
        sent = sent.split('</s>')[1]
        sent = sent.replace('</s>', '')
        print(sent)

body = '''
犬は、前足と後ろ足に体重をかけて歩きます。犬が立つと、後ろ脚の足と膝の間に足首があるのが分かります。人間も、つま先立ちをすると、これに似た格好になります。犬の前脚には足首はありません。人間の腕に足首がないのと同じです。しかし、前脚にも別のタイプの捻挫が起きることがあり、足首の捻挫と同じように対処します。たいていの犬は激しく動き回ります。犬の激しい動きは関節に多大な力と負荷をかけ、時にはこれが怪我を招きます。走る、跳ねる、急に方向転換をするといった動きは関節に大きな負担をかけます。犬の運動量は一様ではありませんが、犬によっては許容量以上の負荷を関節にかけてしまうことがあります。他にも、転ぶ、高所から落ちる、穴に足がはまるといったアクシデントや、ソファーの上り下りのような日常的な行動が原因で捻挫が起こることがあります。捻挫が起こると、まず最初に犬が足を引きずっていることに気づくでしょう。これは捻挫の最も分かりやすい兆候です。捻挫した犬は、痛めた足に体重をかけないようにすることがあります。怪我の度合いにもよりますが、痛めた足を完全に宙に持ち上げて、その足を使わないようにするかもしれません。他の原因でも足を引きずることがあります。腰や膝や足元に怪我を負った犬も足を引きずるかもしれません。捻挫した犬は、足首のまわりが赤く腫れているかもしれません。捻挫した箇所をよく舐める場合もあります。怪我をした犬は、普段とは違う行動をとることがあります。以下の行動の変化に注意しましょう。食欲の変化：怪我をしている犬には食欲の減退が見られます。運動量の変化：睡眠時間が増えたり、動くのを嫌がるようになります。声での訴え：足首を動かしたり触られた時に、吠える、唸る、クンクンと鳴くなどして不快感を訴えます。
'''
generate_summary(body)
'''
===== 原文 =====
犬は、前足と後ろ足に体重をかけて歩きます。犬が立つと、後ろ脚の足と膝の間に足首があるのが分かります。人間も、つま先立ちをすると、これに似た格好になります。犬の前脚には足首はありません。人間の腕に足首がないのと同じです。しかし、前脚にも別のタイプの捻挫が起きることがあり、足首の捻挫と同じように対処します。たいていの犬は激しく動き回ります。犬の激しい動きは関節に多大な力と負荷をかけ、時にはこれが怪我を招きます。走る、跳ねる、急に方向転換をするといった動きは関節に大きな負担をかけます。犬の運動量は一様ではありませんが、犬によっては許容量以上の負荷を関節にかけてしまうことがあります。他にも、転ぶ、高所から落ちる、穴に足がはまるといったアクシデントや、ソファーの上り下りのような日常的な行動が原因で捻挫が起こることがあります。捻挫が起こると、まず最初に犬が足を引きずっていることに気づくでしょう。これは捻挫の最も分かりやすい兆候です。捻挫した犬は、痛めた足に体重をかけないようにすることがあります。怪我の度合いにもよりますが、痛めた足を完全に宙に持ち上げて、その足を使わないようにするかもしれません。他の原因でも足を引きずることがあります。腰や膝や足元に怪我を負った犬も足を引きずるかもしれません。捻挫した犬は、足首のまわりが赤く腫れているかもしれません。捻挫した箇所をよく舐める場合もあります。怪我をした犬は、普段とは違う行動をとることがあります。以下の行動の変化に注意しましょう。食欲の変化：怪我をしている犬には食欲の減退が見られます。運動量の変化：睡眠時間が増えたり、動くのを嫌がるようになります。声での訴え：足首を動かしたり触られた時に、吠える、唸る、クンクンと鳴くなどして不快感を訴えます。
----- 要約 -----
 足首を診察してもらう。関節の問題を診察してもらう。犬の健康診断を受ける。
 適切な対処を行いましょう。
 捻挫の症状を見極めます。歩行と動作の関係を観察します。犬が何をしても痛くないようにします。関節の状態を観察します。犬の行動に変化に注意します。
 捻挫のタイプを確認しましょう。飼い主は痛み止めや軟膏で対処しましょう。
 外傷が疑われる場合は、獣医師の診察を受けましょう。捻挫のタイプを把握しましょう。普段とは違う行動に注意しましょう。飼い犬が捻挫している場合は、触れてはいけません。
'''
```

### Reference
- [wikiHow日本語要約データセット](https://github.com/Katsumata420/wikihow_japanese)
- [rinna株式会社 japanese-gpt2-medium](https://huggingface.co/rinna/japanese-gpt2-medium)
- [GPT-2をファインチューニングしてニュース記事のタイトルを条件付きで生成してみた。](https://qiita.com/m__k/items/36875fedf8ad1842b729)
